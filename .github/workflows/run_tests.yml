name: Run Tests

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    
    - uses: actions-rs/toolchain@v1
      with:
          toolchain: stable
          override: true
    
    - name: Update package manager
      run: |
          sudo apt-get update

    - name: Install prerequisites for Tarpaulin (for code coverage)        
      run: |
          sudo apt-get install libssl-dev pkg-config cmake zlib1g-dev 

    - name: Install Tarpaulin
      run: cargo install cargo-tarpaulin

    - name: Build cfitsio        
      run: |
          sudo ./github/workflows/build.sh

    - name: Run cargo-tarpaulin
      run: cargo tarpaulin --verbose --force-clean --ignore-tests --timeout=360 --out=Lcov --output-dir=./coverage/

    - name: codecov
      run: bash <(curl -s https://codecov.io/bash)
