name: Run Tests

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    
    - uses: actions-rs/toolchain@v1
      with:
          toolchain: stable
          override: true
    
    - name: Install prerequisites for Tarpaulin (for code coverage)        
      run: |
          sudo apt-get update; sudo apt-get install libssl-dev pkg-config cmake zlib1g-dev 

    - name: Install Tarpaulin
      run: cargo install cargo-tarpaulin -f

    - name: Get cfitsio        
      run: |
          wget "https://heasarc.gsfc.nasa.gov/FTP/software/fitsio/c/cfitsio-3.47.tar.gz" -O cfitsio.tar.gz;
          tar -xvf cfitsio.tar.gz;
          cd cfitsio-3.47
          ./configure --prefix=/usr/local --enable-reentrant;
          make clean && make;
          sudo make install;
          sudo ldconfig;
    
    - name: Build
      run: cargo build --verbose
      
    - name: Run cargo-tarpaulin
      run: cargo-tarpaulin --out=Lcov

    - name: Coveralls
      uses: coverallsapp/github-action@master
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}