name: Run Tests

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    
    - uses: actions-rs/toolchain@v1
      with:
          toolchain: stable
          override: true
    
    - name: Update package manager
      run: |
          apt-get -y update

    - name: Install prerequisites for Tarpaulin (for code coverage)        
      run: |
          apt-get -y install libssl-dev pkg-config cmake zlib1g-dev 

    - name: Build cfitsio
      run: |
          # Install dependencies
          curl "https://heasarc.gsfc.nasa.gov/FTP/software/fitsio/c/cfitsio-3.48.tar.gz" -o cfitsio.tar.gz
          tar -xf cfitsio.tar.gz
          rm cfitsio.tar.gz
          cd cfitsio-3.48
          # Enabling SSSE3 could cause portability problems, but it's unlikely that anyone
          # is using such a CPU...
          # https://stackoverflow.com/questions/52858556/most-recent-processor-without-support-of-ssse3-instructions
          CFLAGS="-O3" ./configure --prefix=/usr/local --enable-reentrant --enable-ssse3
          make -j8
          make install
          ldconfig

    - name: Install Tarpaulin
      run: cargo install cargo-tarpaulin

    - name: Run cargo-tarpaulin which will do a cargo build --release
      run: MWALIB_LINK_STATIC_CFITSIO=1 cargo tarpaulin --release --verbose --ignore-tests --timeout=360 --out=Lcov --output-dir=./coverage/

    - name: codecov
      run: bash <(curl -s https://codecov.io/bash)
